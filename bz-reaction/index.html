<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Belousovâ€“Zhabotinsky reaction</title>
    <link rel="stylesheet" type="text/css" href="../js-lib/normalize.css">
	<script language="javascript" type="text/javascript" src="../js-lib/jquery-183.min.js"></script>
	<style type="text/css">
		input,select,button{box-sizing:border-box;height:20px;line-height:20px;padding:0 6px;border:1px solid #999;}
		html,body{margin:0;padding:0}
		#plotDiv{width:480px;height:480px;margin-bottom:20px;}
		#indicatorPanel {margin-top:10px;margin-bottom:10px;}
		#indicatorPanel span{background:#999999;}
		#controlK1,#controlK2,#controlG{width:40px;}
		.controlBlock{display:inline-block;margin-left:10px;}
		#controls button {width: 120px;}
	</style>
</head>
<body>
<canvas id="plotDiv" width="480" height="480"></canvas>
<div id="controls">
<span class="controlBlock">k<sub>1</sub>=<input type="text" name="controlK1" id="controlK1" value="3.0"/></span>
<span class="controlBlock">k<sub>2</sub>=<input type="text" name="controlK2" id="controlK2" value="3.0"/></span>
<span class="controlBlock">g=<input type="text" name="controlG" id="controlG" value="98"/></span>
<br/>
<span class="controlBlock"><button name="restart" id="restart">Start</button> <button name="stop" id="stop">Stop</button></span>
</div>
<script type="text/javascript">
/*options and settings*/
var g;
var timeoutID=null;
var const_k1=3;
var const_k2=3;
var const_g=98;
var field=new Array();

function myParseFloat(val) {
	return parseFloat((""+val).replace(",","."));
}

function stopGame() {
	window.clearInterval(timeoutID);
	timeoutID=null;
	$("#stop").attr("disabled","disabled");
	$("#restart").removeAttr("disabled");
}

function resumeGame() {
	populateField();
	timeoutID=window.setInterval('kadras()',100.0);
	$("#stop").removeAttr("disabled");
	$("#restart").attr("disabled","disabled");
	const_k1=myParseFloat($("#controlK1").val());
	const_k2=myParseFloat($("#controlK2").val());
	const_g=myParseFloat($("#controlG").val());
	if(const_k1<0) const_k1=0;
	if(const_k2<0) const_k2=0;
	if(const_g<0) const_g=0;
	$("#controlK1").attr("value",const_k1);
	$("#controlK2").attr("value",const_k2);
	$("#controlG").attr("value",const_g);
}

function iteracija() {
	var field2={};
	for(var i=0;i<120;i++) {
		field2[i]={};
		for(var j=0;j<120;j++) {
			field2[i][j]=1;
			if(isCellHealthy(i,j)) {
				setCellValue(field2,i,j,getNumInfected(i,j)/const_k1+getNumSick(i,j)/const_k2+1.0);
			} else if(isCellSick(i,j)) {
				setCellValue(field2,i,j,1);
			} else if(isCellInfected(i,j)) {
				setCellValue(field2,i,j,getSuma(i,j)/(getNumInfected(i,j)+getNumSick(i,j)+1.0)+const_g);
			}
		}
	}
	for(var i=0;i<120;i++) {
		for(var j=0;j<120;j++) {
			field[i][j]=field2[i][j];
		}
	}
}

function populateField() {
	field=new Array();
	for(var i=0;i<120;i++) {
		var tfield=new Array();
		for(var j=0;j<120;j++) {
			tfield.push(Math.ceil(255*Math.random()));
		}
		field.push(tfield);
	}
}
function drawField() {
	for(var i=0;i<120;i++) {
		for(var j=0;j<120;j++) {
			var cell=field[i][j];
			g.fillStyle="rgb("+cell+","+cell+","+cell+")";
			g.fillRect(i*4,j*4,4,4);
		}
	}
}

function getNumSick(x,y) {
	var a=0;
	if(isCellSick(x-1,y-1)) a++;if(isCellSick(x-1,y)) a++;if(isCellSick(x-1,y+1)) a++;if(isCellSick(x,y-1)) a++;if(isCellSick(x,y+1)) a++;if(isCellSick(x+1,y-1)) a++;if(isCellSick(x+1,y)) a++;if(isCellSick(x+1,y+1)) a++;
	return a;
}
function getNumInfected(x,y) {
	var a=0;
	if(isCellInfected(x-1,y-1)) a++;if(isCellInfected(x-1,y)) a++;if(isCellInfected(x-1,y+1)) a++;if(isCellInfected(x,y-1)) a++;if(isCellInfected(x,y+1)) a++;if(isCellInfected(x+1,y-1)) a++;if(isCellInfected(x+1,y)) a++;if(isCellInfected(x+1,y+1)) a++;
	return a;
}
function getSuma(x,y) {
	var S=0;
	S+=getCellValue(x-1,y-1);S+=getCellValue(x-1,y);S+=getCellValue(x-1,y+1);S+=getCellValue(x,y-1);S+=getCellValue(x,y);S+=getCellValue(x,y+1);S+=getCellValue(x+1,y-1);S+=getCellValue(x+1,y);S+=getCellValue(x+1,y+1);
	return S;
}
function isCellHealthy(x,y) {
	return (field[(120+x)%120][(120+y)%120]<=1);
}
function isCellInfected(x,y) {
	return (!isCellHealthy(x,y)) && (!isCellSick(x,y));
}
function isCellSick(x,y) {
	return (field[(120+x)%120][(120+y)%120]>=255);
}
function setCellValue(arr,x,y,val) {
	if(val>255) val=255;
	if(val<1) val=1;
	arr[(120+x)%120][(120+y)%120]=Math.floor(val);
}
function getCellValue(x,y) {
	x=(120+x)%120;
	y=(120+y)%120;
	if(field[x][y]>255) field[x][y]=255;
	if(field[x][y]<1) field[x][y]=1;
	return field[x][y];
}

function kadras() {
	iteracija();
	drawField();
}

/*main*/
$(function () {
	g=$("#plotDiv")[0].getContext('2d');
	populateField();
	drawField();
	$("#restart").click(function(){resumeGame();});
	$("#stop").click(function(){stopGame();}).click();
});
</script>
</body>
</html>
