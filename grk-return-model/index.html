<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Return model</title>
    <!-- load default stylesheets -->
    <link rel="stylesheet" type="text/css" href="../js-lib/normalize.css">
    <link rel="stylesheet" type="text/css" href="../js-lib/universal-style.css">
    <!-- load dependencies from ../js-lib -->
    <script language="javascript" type="text/javascript" src="../js-lib/jquery-183.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/plotly-131.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/plotlyPlot.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/commonFunctions.js"></script>
    <!-- [[[ insert custom css code ]]] -->
    <style type="text/css">
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="figureWrapper">
            <div id="pdfPlot" class="halfSize"></div>
            <div id="psdPlot" class="halfSize"></div>
            <div id="seriesPlot" class="fullSize"></div>
        </div><!-- #figureWrapper -->
        <div id="controlWrapper">
            <div class="controlBlockRow">
                <span class="controlBlockTitle" title="Updated after reset unless otherwise specified.">SDE parameters:</span>
                <span class="controlBlock">
                    <input id="simpleSDE" name="simpleSDE" type="checkbox">
                    <label for="simpleSDE">Use simple SDE?</label>
                </span>
                <span class="controlBlock">
                    <label for="lambda">&lambda;=</label>
                    <input id="lambda" name="lambda" type="number" min="2.0" max="5.0" step="0.1" value="3.6">
                </span>
                <span class="controlBlock">
                    <label for="epsilon">&epsilon;=</label>
                    <input id="epsilon" name="epsilon" type="number" min="10" max="30" step="1" value="17"> &middot; 10<sup>-3</sup>
                </span>
                <span class="controlBlock">
                    <label for="eta">&eta;=</label>
                    <input id="eta" name="eta" type="number" min="1.5" max="2.5" step="0.5" value="2.5">
                </span>
                <span class="controlBlock">
                    <label for="xmax">x<sub>max</sub>=</label>
                    <input id="xmax" name="xmax" type="number" min="0" max="10000" step="1" value="1000">
                </span>
            </div><!-- end SDE parameters -->
            <div id="noiseParams" class="controlBlockRow">
                <span class="controlBlockTitle" title="Updated after reset unless otherwise specified.">Noise parameters:</span>
                <span class="controlBlock">
                    <input id="useNoise" name="useNoise" type="checkbox" checked="checked">
                    <label for="useNoise">Use noise?</label>
                </span>
                <span class="controlBlock">
                    <label for="lambdaNoise">&lambda;<sub>2</sub>=</label>
                    <input id="lambdaNoise" name="lambdaNoise" type="number" min="2" max="10" step="0.1" value="5">
                </span>
                <span class="controlBlock">
                    <label for="rNoise"><span style="border-top:1px solid">r</span><sub>0</sub>=</label>
                    <input id="rNoise" name="rNoise" type="number" min="0.1" max="2" step="0.1" value="0.4">
                </span>
            </div><!-- end noise parameters -->
            <div class="controlBlockRow">
                <span class="controlBlockTitle" title="Updated after reset unless otherwise specified.">Realization parameters:</span>
                <span class="controlBlock">
                    <label for="points">log<sub>2</sub>(N)=</label>
                    <input id="points" name="points" type="number" min="10" max="20" step="1" value="15">
                </span>
                <span class="controlBlock">
                    <label for="tauS">&tau;<sub>s</sub>=</label>
                    <input id="tauS" name="tauS" type="number" min="1" max="100" step="1" value="20"> &middot; 10<sup>-5</sup>
                </span>
                <span class="controlBlock" title="Will take effect after a new realization is obtained.">
                    <input name="lgSeries" id="lgSeries" type="checkbox">
                    <label for="lgSeries">Show |r| values on lg axis?</label>
                </span>
            </div><!-- end realization parameters -->
            <div class="controlBlockRow">
                <span class="controlBlock">
                    <button name="getRealization" id="getRealization" title="Obtain realization with previous parameters.">Get realization</button>
                </span>
                <span class="controlBlock">
                    <button name="reset" id="reset" title="Reset to apply new parameters.">Reset</button>
                </span>
            </div><!-- end buttons -->
        </div><!-- #controlWrapper -->
    </div><!-- #wrapper -->
    <!-- [[[ write local code ]]] -->
    <script language="javascript" type="text/javascript">
        // on "Get realization" button click
        $("#getRealization").on("click",function(){
            var params=getParams();
            worker.postMessage({msg: "getRealization", realizationParams: params[2]});
        });
        // on "Reset" button click
        $("#reset").on("click",function() {
            reset();
            pdfPlot.reset();
            psdPlot.reset();
            seriesPlot.reset();
        });
        // on "Use noise?" checkbox state change
        $("#useNoise").on("change",function() {
            // enable/disable related fields
            $("#lambdaNoise, #rNoise").prop("disabled",!$("#useNoise").is(":checked"));
        });
        // on "Use simple SDE?" checkbox state change
        $("#simpleSDE").on("change",function() {
            if($("#simpleSDE").is(":checked")) {
                // set label
                $("label[for=tauS").html("&Delta;t=");
                // disable relevant field
                $("#epsilon").prop("disabled",true);
                // hide noise related parameters
                $("#noiseParams").hide();
            } else {
                // set label
                $("label[for=tauS").html("&tau;<sub>s</sub>=");
                // enable relevant field
                $("#epsilon").prop("disabled",false);
                // show noise related parameters
                $("#noiseParams").show();
            }
        });

        // global worker object
        var worker=null;

        // plots to be plotted
        var pdfPlot=new plotlyPlot("pdfPlot",["lg[|r|]","lg[P(|r|)]"]);
        var psdPlot=new plotlyPlot("psdPlot",["lg[f]","lg[S(f)]"]);
        var seriesPlot=new plotlyPlot("seriesPlot",["time (hours)","lg[|r|]"]);

        // averaging over realizations
        var psdValues=null;
        var pdfValues=null;
        var realizations=0;

        function averageOverRealizations(data) {
            var i;
            if(realizations==0) {
                psdValues=data.psdY.slice(0);
                pdfValues=data.pdf.slice(0);
            } else {
                for(i=0;i<10000;i+=1) {
                    pdfValues[i]=(pdfValues[i]*realizations+data.pdf[i])/(realizations+1.0);
                }
                for(i=0;i<psdValues.length;i+=1) {
                    psdValues[i]=(psdValues[i]*realizations+data.psdY[i])/(realizations+1.0);
                } 
            }
            realizations+=1;
        }

        // plot updating
        function updatePlots(data) {
            // estimate PDF
            var showPdf=commonFunctions.pdfModification(pdfValues,true,0.01,100,100,0.01,0.01);
            // update plots
            if($("#lgSeries").is(":checked")) {
                seriesPlot.setLabels(["time (hours)","lg[|r|]"]);
            } else {
                seriesPlot.setLabels(["time (hours)","|r|"]);
            }
            seriesPlot.update([data.seriesX],[data.seriesY]);
            pdfPlot.update([commonFunctions.toOneDimensionalArray(showPdf,0)],
                           [commonFunctions.toOneDimensionalArray(showPdf,1)]);
            psdPlot.update([data.psdX],[psdValues]);
        }

        // get parameter values from the form
        function getParams() {
            var sdeParams, noiseParams, realizationParams;
            sdeParams={
                simple: $("#simpleSDE").is(":checked"),
                lambda: parseFloat($("#lambda").val()),
                epsilon: parseInt($("#epsilon").val())*1e-3,
                doubleEta: Math.round(2.0*parseFloat($("#eta").val())),
                xmax: parseInt($("#xmax").val()),
            };
            noiseParams={
                use: $("#useNoise").is(":checked"),
                lambda: parseFloat($("#lambdaNoise").val()),
                r0: parseFloat($("#rNoise").val()),
            };
            realizationParams={
                points: Math.pow(2.0,parseInt($("#points").val())),
                dt: parseFloat($("#tauS").val())*1e-5,
                log: $("#lgSeries").is(":checked"),
            };
            return [sdeParams, noiseParams, realizationParams];
        }

        // do reset of the model and averaging
        function reset() {
            // reset averaging
            psdValues=null;
            pdfValues=null;
            realizations=0;
            // reset model
            params=getParams();
            if(worker!=null) {
                worker.terminate();
            }
            worker=new Worker("./returnModelWorker.js");
            worker.postMessage({
                msg: "setParams",
                sdeParams: params[0],
                noiseParams: params[1],
                realizationParams: params[2],
            });
            worker.addEventListener('message', function(e) {
                var i;
                var data=e.data;
                switch(data.msg) {
                    case "getRealization":
                        averageOverRealizations(data);
                        updatePlots(data);
                        break;
                }
            });
        }

        // main initialization on page load
        $(function () {
            reset();
        });
    </script>
</body>
</html>
