<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Three state return model</title>
    <!-- load default stylesheets -->
    <link rel="stylesheet" type="text/css" href="../js-lib/normalize.css">
    <link rel="stylesheet" type="text/css" href="../js-lib/universal-style.css">
    <!-- load dependencies from ../js-lib -->
    <script language="javascript" type="text/javascript" src="../js-lib/jquery-183.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/plotly-131.min.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/plotlyPlot.js"></script>
    <script language="javascript" type="text/javascript" src="../js-lib/commonFunctions.js"></script>
</head>
<body>
    <div id="wrapper">
        <div id="figureWrapper">
            <div id="psdPlot" class="fullSize"></div>
        </div><!-- #figureWrapper -->
        <div id="controlWrapper">
            <div class="controlBlockRow">
                <span class="controlBlockTitle">
                    Individual behavior parameters:
                </span>
                <span class="controlBlock">
                    <label for="a1">a<sub>1</sub>=</label>
                    <input id="a1" name="a1" type="number" min="0" max="1000" step="1" value="30">
                </span>
                <span class="controlBlock">
                    <label for="a2">a<sub>2</sub>=</label>
                    <input id="a2" name="a2" type="number" min="0" max="1000" step="1" value="30">
                </span>
                <span class="controlBlock">
                    <label for="b1">b<sub>1</sub>=</label>
                    <input id="b1" name="b1" type="number" min="0" max="1000" step="1" value="30">
                </span>
                <span class="controlBlock">
                    <label for="b2">b<sub>2</sub>=</label>
                    <input id="b2" name="b2" type="number" min="0" max="1000" step="1" value="500">
                </span>
                <span class="controlBlock">
                    <label for="c1">c<sub>1</sub>=</label>
                    <input id="c1" name="c1" type="number" min="0" max="1000" step="1" value="30">
                </span>
                <span class="controlBlock">
                    <label for="c2">c<sub>2</sub>=</label>
                    <input id="c2" name="c2" type="number" min="0" max="1000" step="1" value="500">
                </span>
            </div>
            <div class="controlBlockRow">
                <span class="controlBlockTitle">
                    Herding behavior parameters:
                </span>
                <span class="controlBlock">
                    <label for="H">H=</label>
                    <input id="H" name="H" type="number" min="1" max="1000" step="1" value="50">
                </span>
            </div>
            <div class="controlBlockRow">
                <span class="controlBlockTitle">
                    Time scale parameters:
                </span>
                <span class="controlBlock">
                    <label for="T">T=</label>
                    <input id="T" name="T" type="number" min="1" max="1000" step="1" value="10"> &middot; 10<sup>-4</sup>
                </span>
            </div>
            <div class="controlBlockRow">
                <span class="controlBlock">
                    <button name="getRealization" id="getRealization" title="Obtain realization with previous parameters." disabled="disabled">Get realization</button>
                </span>
                <span class="controlBlock">
                    <button name="reset" id="reset" title="Reset to apply new parameters.">Reset</button>
                </span>
            </div><!-- end buttons -->
        </div><!-- #controlWrapper -->
    </div><!-- #wrapper -->
    <!-- [[[ write local code ]]] -->
    <script language="javascript" type="text/javascript">
        // on "Get realization" button click
        $("#getRealization").on("click",function(){
            var params=getParams();
            worker.postMessage({msg: "getRealization", realizationParams: params[2]});
            $("#getRealization").prop("disabled",true);
        });
        // on "Reset" button click
        $("#reset").on("click",function() {
            reset();
            $("#getRealization").prop("disabled",false);
            psdPlot.reset();
        });

        // global worker object
        var worker=null;

        // plots to be plotted
        var psdPlot=new plotlyPlot("psdPlot",["lg[f]","lg[S(f)]"]);

        // averaging over realizations
        var psdValues=null;
        var realizations=0;

        function averageOverRealizations(data) {
            var i;
            if(realizations==0) {
                psdValues=data.psdY.slice(0);
            } else {
                for(i=0;i<psdValues.length;i+=1) {
                    psdValues[i]=(psdValues[i]*realizations+data.psdY[i])/(realizations+1.0);
                } 
            }
            realizations+=1;
        }

        // plot updating
        function updatePlots(data) {
            // update plots
            psdPlot.update([data.psdX],[psdValues]);
        }

        // get parameter values from the form
        function getParams() {
            return {
                    a1: parseFloat($("#a1").val()),
                    a2: parseFloat($("#a2").val()),
                    b1: parseFloat($("#b1").val()),
                    b2: parseFloat($("#b2").val()),
                    c1: parseFloat($("#c1").val()),
                    c2: parseFloat($("#c2").val()),
                    H: parseFloat($("#H").val()),
                    T: parseFloat($("#T").val())*1e-4,
                };
        }

        // do reset of the model and averaging
        function reset() {

            // reset averaging
            psdValues=null;
            realizations=0;
            // reset model
            params=getParams();
            if(worker!=null) {
                worker.terminate();
            }
            worker=new Worker("./abmThreeTypeWorker.js");
            worker.postMessage({
                msg: "setParams",
                params: params,
            });
            worker.addEventListener('message', function(e) {
                var data=e.data;
                switch(data.msg) {
                    case "getRealization":
                        averageOverRealizations(data);
                        updatePlots(data);
                        $("#getRealization").prop("disabled",false);
                        break;
                }
            });
        }

        // main initialization on page load
        $(function () {
            reset();
        });
    </script>
</body>
</html>
